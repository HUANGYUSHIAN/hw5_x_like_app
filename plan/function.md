# X-like App 功能說明與流程

本文檔詳細描述整個應用程式允許的所有功能、操作流程和限制。

## 目錄

1. [認證與註冊](#認證與註冊)
2. [用戶管理](#用戶管理)
3. [發文功能](#發文功能)
4. [互動功能](#互動功能)
5. [關注系統](#關注系統)
6. [通知系統](#通知系統)
7. [聊天功能](#聊天功能)
8. [草稿管理](#草稿管理)
9. [個人資料](#個人資料)
10. [即時更新](#即時更新)
11. [內容限制與規則](#內容限制與規則)

---

## 認證與註冊

### 支援的登入方式

#### 1. OAuth 登入（主要方式）
- **GitHub OAuth**：優先使用（如果已配置）
- **Google OAuth**：次優先（如果已配置）


**流程：**
1. 用戶點擊 OAuth 登入按鈕（GitHub 或 Google）
2. 跳轉到對應的 OAuth 提供商授權頁面
3. 用戶授權後，OAuth 提供商回傳用戶資料（email、name、image）
4. 系統根據 **email** 查找資料庫中是否已有該用戶
   - **如果找到**：直接登入，跳轉到首頁
   - **如果未找到**：標記為需要註冊，跳轉到 `/auth/register`
5. 新用戶在註冊頁面輸入唯一的 `userID`（必須唯一，可檢查）
6. 註冊成功後，創建用戶記錄，綁定 OAuth 資訊，跳轉到首頁

**限制：**
- OAuth 登入必須提供 `email`，否則登入失敗
- 新用戶必須先註冊 `userID` 才能使用其他功能
- `userID` 必須唯一，系統會檢查重複

#### 2. 測試登入（後門機制）
- **用途**：開發和測試環境使用
- **流程**：
  1. 用戶在登入頁面輸入 `User ID` 和 `Name`
  2. 系統驗證資料庫中是否存在該 `User ID` 和對應的 `Name`
  3. 如果驗證通過，創建 `test-auth-token` cookie，登入成功
  4. 如果驗證失敗，顯示錯誤訊息

**限制：**
- 測試登入的用戶必須已存在於資料庫中
- `User ID` 和 `Name` 必須完全匹配資料庫記錄
- 測試登入使用獨立的 `test-auth-token` cookie，與 OAuth 登入分離

### Session 管理

**Session 持久化：**
- OAuth 登入：使用 NextAuth 的 session cookie（`__Secure-next-auth.session-token` 或 `next-auth.session-token`）
- 測試登入：使用 `test-auth-token` cookie
- 所有登入方式都會將 `userID` 保存到 `localStorage`，確保持久化

**Session 有效期：**
- Session 有效期：30 天
- Session 更新間隔：24 小時

**登出：**
- 清除所有認證相關的 cookies（NextAuth 和測試登入）
- 清除 `localStorage` 中的 `userID`
- 重定向到登入頁面

---

## 用戶管理

### 用戶註冊

**OAuth 新用戶註冊流程：**
1. OAuth 登入成功，但資料庫中沒有該 email 的記錄
2. 系統標記 `needsRegistration = true`
3. 跳轉到 `/auth/register` 註冊頁面
4. 顯示 OAuth 提供商資訊（GitHub 或 Google）和 email
5. 用戶輸入 `userID`（必須唯一）
6. 可以點擊 "Check" 按鈕檢查 `userID` 是否可用
7. 提交註冊：
   - 系統再次檢查 `userID` 唯一性
   - 如果重複，顯示錯誤，要求更改
   - 如果唯一，創建用戶記錄，綁定 OAuth 資訊和 `userID`
8. 註冊成功，跳轉到首頁

**限制：**
- `userID` 必須唯一，系統會檢查重複
- `userID` 格式：小寫字母和數字，最多 20 個字元（新註冊時）
- Email 不可修改（綁定 OAuth）

### 用戶 ID 管理

**設置 User ID：**
- 新 OAuth 用戶必須在註冊時設置 `userID`
- 如果用戶有臨時 `userID`（以 `temp_` 開頭），必須在個人資料編輯頁面設置正式 `userID`

**修改 User ID：**
- 已註冊用戶可以在個人資料編輯頁面（`/{userId}/edit`）修改 `userID`
- 修改時必須檢查新 `userID` 的唯一性
- 修改成功後，session 會自動更新新的 `userID`

**限制：**
- `userID` 必須唯一
- 修改 `userID` 時，系統會檢查重複
- Email 不可修改（綁定 OAuth）

---

## 發文功能

### 發文流程

1. **進入發文頁面**：
   - 點擊左側欄位的 "POST" 按鈕，跳轉到 `/compose/post`
   - 或點擊首頁的 "What's happening?" 輸入框

2. **輸入內容**：
   - 文字內容：最多 280 字元
   - 支援 URL：每個 URL 固定計為 23 字元
   - 支援 Hashtag（`#hashtag`）：不計入字元數
   - 支援 Mention（`@userID`）：不計入字元數
   - 顯示即時字元計數

3. **保存草稿**（可選）：
   - 點擊 "Save Draft" 按鈕保存為草稿
   - 草稿會保存到資料庫，可以稍後編輯或發送

4. **發送文章**：
   - 點擊 "Post" 按鈕發送
   - 系統驗證字元數限制
   - 創建文章記錄
   - 觸發 Pusher 事件，通知所有關注者
   - 跳轉回首頁，新文章出現在 Feed 最上方

### 文章內容限制

**字元數計算規則：**
- 普通文字：每個字元計為 1
- URL：每個 URL 固定計為 23 字元（無論實際長度）
- Hashtag（`#hashtag`）：不計入字元數
- Mention（`@userID`）：不計入字元數
- 總字元數上限：280 字元

**內容解析：**
- URL 自動識別並轉換為可點擊連結
- Hashtag 顯示為藍色，可點擊（目前無功能）
- Mention 顯示為藍色，點擊跳轉到對應用戶的個人頁面

### 文章管理

**編輯文章：**
- 只有文章作者可以編輯自己的文章
- 在文章卡片右上角點擊編輯圖標，選擇 "Edit"
- 修改內容後保存，文章即時更新

**刪除文章：**
- 只有文章作者可以刪除自己的文章
- 在文章卡片右上角點擊編輯圖標，選擇 "Delete"
- 確認刪除後，文章從 Feed 中移除
- 相關的按讚、轉發、留言也會被處理

---

## 互動功能

### 按讚（Like）

**流程：**
1. 用戶點擊文章下方的愛心圖標
2. 如果未按讚：創建 Like 記錄，讚數 +1，圖標變紅色
3. 如果已按讚：刪除 Like 記錄，讚數 -1，圖標變灰色
4. 觸發 Pusher 事件，即時更新所有正在查看該文章的用戶

**限制：**
- 每個用戶對每篇文章只能按讚一次
- 可以取消按讚

**查看按讚列表：**
- 在個人資料頁面的 "Likes" 標籤中查看該用戶按讚的所有文章

### 轉發（Repost）

**流程：**
1. 用戶點擊文章下方的轉發圖標
2. 如果未轉發：創建 Repost 記錄，轉發數 +1，圖標變綠色
3. 如果已轉發：刪除 Repost 記錄，轉發數 -1，圖標變灰色
4. 觸發 Pusher 事件，即時更新所有正在查看該文章的用戶

**限制：**
- 每個用戶對每篇文章只能轉發一次
- 可以取消轉發
- 轉發的文章會出現在轉發者的個人資料頁面

**查看轉發列表：**
- 在個人資料頁面的 "Reposts" 標籤中查看該用戶轉發的所有文章

### 留言（Comment）

**流程：**
1. 用戶點擊文章下方的留言圖標，或進入文章詳情頁面
2. 在留言輸入框中輸入內容（同樣遵循 280 字元限制）
3. 點擊 "Reply" 發送留言
4. 創建 Comment 記錄，留言數 +1
5. 觸發 Pusher 事件，即時更新所有正在查看該文章的用戶
6. 留言顯示在文章下方

**多層留言（Recursive Comments）：**
- 支援對留言進行回覆（Reply to Comment）
- 回覆會顯示在原留言下方，形成樹狀結構
- 可以無限層級回覆

**留言管理：**
- 只有留言作者可以刪除自己的留言
- 刪除留言時，相關的回覆也會被處理

**查看留言：**
- 在文章詳情頁面（`/posts/[postId]`）查看所有留言
- 留言按時間排序（最新的在最上方）

---

## 關注系統

### 關注/取消關注

**流程：**
1. 用戶訪問其他用戶的個人頁面（`/{userId}`）
2. 點擊 "Follow" 按鈕
3. 如果未關注：創建 Follow 記錄，關注數 +1，按鈕變為 "Following"
4. 如果已關注：刪除 Follow 記錄，關注數 -1，按鈕變為 "Follow"
5. 觸發 Pusher 事件，即時更新被關注用戶的關注者數量
6. 創建通知，通知被關注用戶

**限制：**
- 不能關注自己
- 每個用戶對每個用戶只能關注一次
- 可以取消關注

### 關注列表

**查看關注者（Followers）：**
- 在個人資料頁面的 "Followers" 標籤中查看所有關注該用戶的用戶列表
- 顯示關注者數量

**查看關注中（Following）：**
- 在個人資料頁面的 "Following" 標籤中查看該用戶關注的所有用戶列表
- 顯示關注中數量

### Feed 過濾

**All 標籤：**
- 未登入用戶：顯示所有用戶的所有文章
- 已登入用戶：顯示當前用戶自己的文章 + 所有關注用戶的文章
- 如果用戶沒有關注任何人，只顯示自己的文章

**Following 標籤：**
- 只顯示當前用戶關注的用戶發表的文章
- 如果沒有關注任何人，顯示空列表

---

## 通知系統

### 通知類型

系統支援以下類型的通知：

1. **Follow 通知**：當有用戶關注你時
2. **Like 通知**：當有用戶對你的文章按讚時
3. **Comment 通知**：當有用戶對你的文章留言時
4. **Repost 通知**：當有用戶轉發你的文章時
5. **Post 通知**：當你關注的用戶發文時（即時通知）

### 通知流程

**創建通知：**
- 當用戶執行互動操作（關注、按讚、留言、轉發）時，系統自動創建通知
- 當關注的用戶發文時，系統創建 Post 通知

**顯示通知：**
- 在通知頁面（`/notifications`）查看所有通知
- 通知按時間排序（最新的在最上方）
- 未讀通知會標記為未讀狀態

**即時通知（Post 通知）：**
- 當關注的用戶發文時，會在頁面頂部顯示 Toast 通知
- Toast 通知包含 "Show" 按鈕，點擊跳轉到新文章
- 這個通知在所有路由都可用（不僅僅是首頁）

**標記為已讀：**
- 用戶可以點擊通知標記為已讀
- 可以批量標記所有通知為已讀

**通知連結：**
- Follow 通知：點擊跳轉到關注者的個人頁面
- Like/Repost 通知：點擊跳轉到對應的文章
- Comment 通知：點擊跳轉到文章詳情頁面
- Post 通知：點擊跳轉到新文章

---

## 聊天功能

### 聊天對象

**互相關注（Mutual Follows）：**
- 只有互相關注的用戶才能互相發送訊息
- 系統會自動過濾出所有互相關注的用戶列表

### 聊天流程

1. **進入聊天頁面**：
   - 點擊左側欄位的 "Chat" 選項，跳轉到 `/chat`

2. **選擇聊天對象**：
   - 在頁面頂部的下拉選單中選擇要聊天的用戶
   - 下拉選單只顯示互相關注的用戶

3. **發送訊息**：
   - 在輸入框中輸入訊息內容
   - 支援純文字和超連結
   - 點擊 "Send" 發送訊息
   - 訊息保存到資料庫
   - 觸發 Pusher 事件，即時傳送給對方

4. **查看訊息**：
   - 自己的訊息顯示在右側（對齊右側）
   - 對方的訊息顯示在左側（對齊左側）
   - 訊息按時間排序（最新的在最下方）
   - 自動滾動到最新訊息

### 訊息內容

**支援的內容類型：**
- 純文字
- 超連結（自動識別並轉換為可點擊連結）

**不支援的內容類型：**
- 圖片
- 檔案
- 富文本格式

### 即時更新

- 使用 Pusher 實現即時訊息傳送
- 當對方發送訊息時，會即時顯示在你的聊天視窗中
- 不需要手動刷新頁面

---

## 草稿管理

### 保存草稿

**流程：**
1. 在發文編輯器中輸入內容
2. 點擊 "Save Draft" 按鈕
3. 草稿保存到資料庫
4. 可以稍後繼續編輯或發送

### 查看草稿

**草稿列表：**
- 訪問 `/drafts` 頁面查看所有草稿
- 草稿按最後更新時間排序（最新的在最上方）

**未發送草稿：**
- 訪問 `/compose/post/unsent/drafts` 查看未發送的草稿
- 這些是已保存但尚未發送的草稿

### 編輯草稿

**流程：**
1. 在草稿列表中點擊要編輯的草稿
2. 在發文編輯器中繼續編輯
3. 可以再次保存為草稿，或直接發送

### 刪除草稿

**流程：**
1. 在草稿列表中點擊刪除按鈕
2. 確認刪除
3. 草稿從列表中移除

---

## 個人資料

### 查看個人資料

**訪問個人頁面：**
- 點擊左側欄位的 "Profile" 選項，跳轉到 `/{userId}`
- 或點擊其他用戶的頭像/名稱，跳轉到 `/{userId}`

**個人頁面內容：**
- 用戶頭像、背景圖片
- 用戶名稱、`@userID`、Bio
- 關注者數量、關注中數量
- 文章數量、轉發數量、按讚數量
- 標籤頁：Posts、Reposts、Likes

### 編輯個人資料

**流程：**
1. 訪問自己的個人頁面
2. 點擊 "Edit Profile" 按鈕，跳轉到 `/{userId}/edit`
3. 可以修改以下欄位：
   - User ID（必須唯一，可檢查）
   - Name（名稱）
   - Bio（個人簡介）
   - Avatar URL（頭像圖片 URL）
   - Background URL（背景圖片 URL）
4. Email 不可修改（綁定 OAuth）
5. 點擊 "Save" 保存更改

**User ID 修改：**
- 如果修改 User ID，系統會檢查唯一性
- 可以點擊 "Check" 按鈕檢查新 User ID 是否可用
- 修改成功後，session 會自動更新新的 User ID
- URL 會自動更新為新的 `/{newUserId}`

**新用戶註冊完成：**
- 如果用戶有臨時 User ID（以 `temp_` 開頭），編輯頁面會顯示 "完成註冊" 提示
- 必須設置正式的 User ID 才能完成註冊
- User ID 格式：小寫字母和數字，最多 20 個字元

### 個人頁面標籤

**Posts 標籤：**
- 顯示該用戶發表的所有文章（不包括轉發）

**Reposts 標籤：**
- 顯示該用戶轉發的所有文章

**Likes 標籤：**
- 顯示該用戶按讚的所有文章

**Followers 標籤：**
- 顯示所有關注該用戶的用戶列表

**Following 標籤：**
- 顯示該用戶關注的所有用戶列表

---

## 即時更新

### Pusher 即時更新

系統使用 Pusher 實現即時更新功能，無需手動刷新頁面。

### 支援的即時更新

1. **文章按讚數更新**：
   - 當有用戶對文章按讚或取消按讚時
   - 所有正在查看該文章的用戶會即時看到讚數變化

2. **文章留言數更新**：
   - 當有用戶對文章留言時
   - 所有正在查看該文章的用戶會即時看到留言數變化

3. **文章轉發數更新**：
   - 當有用戶轉發文章時
   - 所有正在查看該文章的用戶會即時看到轉發數變化

4. **新文章通知**：
   - 當關注的用戶發文時
   - 會在頁面頂部顯示 Toast 通知（所有路由都可用）
   - 通知包含 "Show" 按鈕，點擊跳轉到新文章

5. **聊天訊息即時傳送**：
   - 當對方發送訊息時
   - 會即時顯示在你的聊天視窗中

6. **關注者數量更新**：
   - 當有用戶關注或取消關注時
   - 被關注用戶的個人頁面會即時更新關注者數量

### Pusher 頻道

**公開頻道：**
- `public-posts`：所有用戶都可以訂閱，接收公開文章更新

**私有頻道：**
- `private-user-{userId}`：只有對應用戶可以訂閱，接收個人相關更新

---

## 內容限制與規則

### 字元數限制

**文章內容：**
- 最大字元數：280 字元
- URL 計數：每個 URL 固定 23 字元
- Hashtag 和 Mention 不計入字元數

**留言內容：**
- 最大字元數：280 字元
- 同樣遵循 URL、Hashtag、Mention 的計數規則

### 內容格式

**支援的格式：**
- 純文字
- URL（自動識別並轉換為可點擊連結）
- Hashtag（`#hashtag`，顯示為藍色）
- Mention（`@userID`，顯示為藍色，點擊跳轉到用戶個人頁面）

**不支援的格式：**
- 富文本（粗體、斜體等）
- 圖片（目前不支援上傳圖片，但可以通過 URL 顯示）
- 影片
- 檔案附件

### 用戶 ID 規則

**User ID 格式：**
- 新註冊：小寫字母和數字，最多 20 個字元
- 已註冊用戶修改：必須唯一，系統會檢查重複

**User ID 唯一性：**
- 系統會檢查 User ID 是否已被使用
- 可以通過 "Check" 按鈕檢查可用性
- 註冊或修改時會再次檢查唯一性

### 權限規則

**文章權限：**
- 只有文章作者可以編輯或刪除自己的文章
- 所有用戶都可以查看、按讚、轉發、留言

**留言權限：**
- 只有留言作者可以刪除自己的留言
- 所有用戶都可以查看和回覆留言

**個人資料權限：**
- 只有用戶本人可以編輯自己的個人資料
- 所有用戶都可以查看其他用戶的個人資料（不包括 private like）

**聊天權限：**
- 只有互相關注的用戶才能互相發送訊息

### 互動限制

**按讚限制：**
- 每個用戶對每篇文章只能按讚一次
- 可以取消按讚

**轉發限制：**
- 每個用戶對每篇文章只能轉發一次
- 可以取消轉發

**關注限制：**
- 不能關注自己
- 每個用戶對每個用戶只能關注一次
- 可以取消關注

---

## 路由與頁面

### 公開路由（無需登入）

- `/auth/signin`：登入頁面
- `/auth/register`：註冊頁面（OAuth 新用戶）
- `/{userId}`：用戶個人頁面（查看）

### 受保護路由（需要登入）

- `/`：首頁 Feed
- `/compose/post`：發文頁面
- `/compose/post/unsent/drafts`：未發送草稿列表
- `/drafts`：草稿列表
- `/{userId}/edit`：編輯個人資料
- `/posts/[postId]`：文章詳情頁面
- `/comments/[commentId]`：留言詳情頁面
- `/notifications`：通知頁面
- `/explore`：探索頁面（搜尋用戶）
- `/chat`：聊天頁面

### 中間件保護

- 所有受保護路由都會通過 `middleware.ts` 檢查認證狀態
- 未登入用戶會被重定向到 `/auth/signin`
- 需要註冊的用戶會被重定向到 `/auth/register`
- 需要設置 User ID 的用戶會被重定向到 `/{tempUserId}/edit`

---

## 資料持久化

### Session 持久化

**OAuth 登入：**
- 使用 NextAuth 的 session cookie
- Session 有效期：30 天
- Session 更新間隔：24 小時

**測試登入：**
- 使用 `test-auth-token` cookie
- Cookie 有效期：30 天

**User ID 持久化：**
- 所有登入方式都會將 `userID` 保存到 `localStorage`
- 確保持久化，即使 session 刷新也能保留

### 資料庫持久化

**所有資料都保存到 MongoDB：**
- 用戶資料
- 文章
- 留言
- 按讚記錄
- 轉發記錄
- 關注記錄
- 草稿
- 通知
- 聊天訊息

---

## 錯誤處理

### 認證錯誤

- **未登入**：重定向到 `/auth/signin`
- **需要註冊**：重定向到 `/auth/register`
- **需要設置 User ID**：重定向到 `/{tempUserId}/edit`
- **OAuth 錯誤**：顯示錯誤訊息，重定向到 `/auth/signin`

### 驗證錯誤

- **User ID 重複**：顯示錯誤訊息，要求更改
- **字元數超限**：顯示錯誤訊息，禁止發送
- **必填欄位缺失**：顯示錯誤訊息，要求填寫

### 權限錯誤

- **無權限編輯**：顯示 "You are not authorized to edit this profile" 錯誤
- **無權限刪除**：顯示錯誤訊息，禁止操作

---

## 總結

本應用程式提供完整的社群平台功能，包括：

✅ **認證系統**：OAuth 登入（GitHub、Google）和測試登入  
✅ **用戶管理**：註冊、個人資料編輯、User ID 管理  
✅ **發文功能**：發文、編輯、刪除、字元數限制、內容解析  
✅ **互動功能**：按讚、轉發、留言（多層留言）  
✅ **關注系統**：關注/取消關注、關注列表、Feed 過濾  
✅ **通知系統**：多種類型通知、即時通知、已讀標記  
✅ **聊天功能**：互相關注用戶聊天、即時訊息  
✅ **草稿管理**：保存、查看、編輯、刪除草稿  
✅ **即時更新**：Pusher 即時更新所有互動  
✅ **個人資料**：查看、編輯、多標籤頁面  

所有功能都遵循嚴格的權限控制和資料驗證規則，確保系統安全穩定運行。

